const express = require('express');
const { spawn } = require('child_process');
const path = require('path');
const app = express();

app.use(express.json());

// --- CONFIGURATION ---
const SESSION_DATA = "CYPHER-X:~UEsDBBQAAAgIAOgSmlu0JXeLPgUAAJMLAAAKAAAAY3JlZHMuanNvbs2WWW*jNhDHvwtfY9S6DwMBKpGUbMv3KbvoAyNRsmxdpijb8iLfvZCT7C7QdpECeaieKB7D3*w5nOE3kBdJRT3agN43ULLkQjhtm7wpKegBu44iykAHhIQT0AOK51gWPU70C75JIhdvKowCyXfv2h6jwZOCfM8eO*4Kr4Vn8NoBZf2SJsEvDKpuHvpkKw6u1nLi4fH8oIZNao3Po+Y+1eEaouR0d8UsWl2fwWtrkSQsyWNcHmhGGUk92sxIwj6H3wwi*bjtL06mUHQrqVuW6q5aH4Xb4BIE8k56Iaa5dPN4uB18Dn8jDt1+IG*OYWrIccBu1nk9ry5U3BhGhJb32ybqnnZCvzzN3*CrJM5pOAhpzhPefFp310lsG1WlfjQskwdhHe378T6ILLkN7lypT6N6vE3ikurkOPgcuBnsyKs4cesfKdBVYB+Jq7niHUIrG9aR72YghPMleNHOUn8Fn7CNWTv9J9wk2pKXqCIaDd94ALxUUm5GWIuW405uFcN*3F6eVt+Z4*jl8TaR8cTTFfb3pas6MOMN9OKkvq*sJrVlw3D9NzqtT*yyRVfwDn*Ca*YpyPYqpXJPlJtuK51qfHPr29lweiHeEymTXjIcD9mTIA1eZYzczDlEWO8HciYjUSFux3uSjBduVRvxEVPPo7wNXixqUXJ8fHp1oMwhBT3ztAEbjpOKM8KTI2z5J6gASXpY0YJQ*1AU2vgklWsf+7Cjcgv2pIcqUXLf6y80R97Exw8hc75m7URB+Bh1QsiKgVUXDflLxgjVjWlUkphXo*fE4qNZnRrOC02ESgh6QZFkVFF0UdEH4vfrteiC8ImX5W0456ICIFdmYgl5E0op2wGOFBbGiqbZkQwh1HUEsIlXSZMGyBQGqstVCEMaTIClJzkEPgNankNGqSvJ4XISt3mXeKpG9wa2SjFacZCXoibqm6aIkmspr58t4HU1WFWzpAjJFw7ShYiJJsw3LEEwkyv8*XlNDFjIR1FXBMhTVMbCADQmbugZ1xf7*8doQixAhS9NUx3ZkFWu2rskYI0dGuv41vOoX8loS0hzbwqKgqLJliqqsqoqNJF1AtoC+hlf7Ql6EkIotWcWW4zhIUhXHkQXLclSoYNP4Gl799c8OyOmNv6X1NhkZotwBUcIqvs7rMi1I+JH0v4+SICjqnC+bPIBtgzLQE390U86TPK5aDeqcsOCQXChsPX738HsGpIyGoMdZTb9XdfgG7o3Q3FkZPmjpW0N*U7En*V3H9DHLUCVFMlRZ0Q1VN3rS7213B+Qke1hO8rgV5R22tR1STpK0Aj0AB8v43N1hPLu73Chc18KxBeM2uX0491FF3tL0cWGM9cHYK5St7ixqkw7z7r044Gx6mCrQ3w9nipYtvLl3Wz**gxHQA+nGPQ8ZPB98Vs9YMH5ZnpJVnYzMm2Lvzkvv4qGRDHcugcT3LvUkLLuuBzXfXm9X92onHUU1kVK*YBucQl+pMywvYVtyOiCklySgP28WBodkgrvECqTrfj6+xdGauNSXldnTHXumVI8y2acvGB+vo3m+zAh9yfdWpdUXAefXQPNpl93m3E*De0bKvjuNFXqI3+rbo76m7++a5L30JI*fKKGPZ8L7EfzLAb3htkEmvHZ+Wvn+3PiXkm3vhAhNGwTPU6e+rV8ufrLvGtpgMTwWq9pKpeXqaVqelidYbcBrG+5lSnhUsAz0AMlDVjw2Z0XdBu0gj4pfbAataoDmMWr9TUnFrR8X4Z9ul*Q2a8aKsk+qQxvBrmJldRvVjVWWS074x8UCVvuNCwe8*gVQSwECFAMUAAAICADoEppbtCV3iz4FAACTCwAACgAAAAAAAAAAAAAApIEAAAAAY3JlZHMuanNvblBLBQYAAAAAAQABADgAAABmBQAAAAA=";

let BOTS = {
    'Cypher-X': { folder: 'CypherX', file: 'index.js', process: null, status: 'Offline' }
};

// --- FRONTEND (HTML) ---
const HTML_DASHBOARD = `
<!DOCTYPE html>
<html>
<head>
    <title>Cypher-X Panel</title>
    <style>
        body { background: #0b141a; color: white; font-family: sans-serif; text-align: center; padding: 50px; }
        .panel { background: #202c33; padding: 30px; border-radius: 20px; display: inline-block; border-top: 4px solid #00a884; width: 400px; }
        .status { font-size: 1.2rem; margin: 20px 0; padding: 10px; border-radius: 5px; }
        .Online { background: rgba(0, 168, 132, 0.2); color: #00a884; border: 1px solid #00a884; }
        .Offline { background: rgba(234, 0, 56, 0.2); color: #ea0038; border: 1px solid #ea0038; }
        button { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .start { background: #00a884; color: white; }
        .stop { background: #ea0038; color: white; }
    </style>
</head>
<body>
    <div class="panel">
        <h1 style="color: #00a884">Cypher-X</h1>
        <div id="st" class="status Offline">Status: Offline</div>
        <button class="start" onclick="run('start')">START DEPLOYMENT</button>
        <button class="stop" onclick="run('stop')">TERMINATE</button>
    </div>
    <script>
        async function up() {
            const r = await fetch('/api/status');
            const d = await r.json();
            const s = document.getElementById('st');
            s.innerText = "Status: " + d[0].status;
            s.className = "status " + d[0].status;
        }
        async function run(a) {
            await fetch('/api/' + a, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: 'Cypher-X' })});
            setTimeout(up, 1000);
        }
        setInterval(up, 3000);
        up();
    </script>
</body>
</html>
`;

// --- API ROUTES ---
app.get('/', (req, res) => res.send(HTML_DASHBOARD));

app.get('/api/status', (req, res) => {
    res.json(Object.keys(BOTS).map(n => ({ name: n, status: BOTS[n].status })));
});

app.post('/api/start', (req, res) => {
    const bot = BOTS['Cypher-X'];
    if (bot && !bot.process) {
        const botPath = path.join(__dirname, 'bots', bot.folder);
        const child = spawn('node', [path.join(botPath, bot.file)], {
            cwd: botPath,
            env: { ...process.env, SESSION_ID: SESSION_DATA }
        });
        bot.process = child;
        bot.status = 'Online';
        child.stdout.on('data', d => console.log(\`[BOT]: \${d}\`));
        child.on('close', () => { bot.process = null; bot.status = 'Offline'; });
        res.json({ status: 'OK' });
    }
});

app.post('/api/stop', (req, res) => {
    if (BOTS['Cypher-X'].process) {
        BOTS['Cypher-X'].process.kill();
        res.json({ status: 'Stopped' });
    }
});

app.listen(3000, () => console.log('OPEN BROWSER TO: http://localhost:3000'));
